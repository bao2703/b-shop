pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
spec:
  containers:
  - name: netcore31
    image: mcr.microsoft.com/dotnet/core/sdk:3.1
    tty: true
"""
        }
    }
    environment {
        PROJECT = "Identity.API"
    }
    stages { 
        stage('Build') {
            steps {
                container('netcore31') {
                    sh '''
                        cd ./src/${PROJECT}
                        dotnet restore
                        dotnet build --no-restore
                    '''
                }
            }
        }
        stage('FunctionalTests') {
            steps {
                container('netcore31') {
                    sh '''
                        cd ./tests/${PROJECT}/${PROJECT}.FunctionalTests
                        dotnet test -c Release /p:CollectCoverage=true
                    '''
                }
            }
        }
        stage('UnitTests') {
            steps {
                container('netcore31') {
                    sh '''
                        cd ./tests/${PROJECT}/${PROJECT}.UnitTests
                        dotnet test -c Release /p:CollectCoverage=true
                    '''
                }
            }
        }
    }
}
